<html>

<head>
  <style media="screen">
    video#myvideo {
      display: none;
    }
    #answer_button {
      display: none;
    }
    #hangup_button {
      display: none;
    }
  </style>
  <script src="peer.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script type="text/javascript">
    let incomingcall = false;
    let outgoingcall = false;
    let callinprogress = false;
    var audio = new Audio('phone_message.wav');
    var socket = io.connect();

    socket.on('connect', function() {
      console.log("Connected");
    });

    socket.on('tring', function(e) {
      incomingcall = true;
      document.getElementById('call_button').style.display = "none";
      document.getElementById('answer_button').style.display = "inline";
      document.getElementById('hangup_button').style.display = "inline";
      // window.alert("you're getting call! answer using the button on the page!")
      setInterval(function() {
        if (incomingcall && !outgoingcall && !callinprogress) {
          audio.play();
          console.log("incoming!");
        }
      }, 3000);
    });

    socket.on('hangup', function(e) {
      // window.alert("you're getting call! answer using the button on the page!")
      if (incomingcall && !outgoingcall && !callinprogress) {
        audio.pause();
        console.log("missed call");
        incomingcall = false;
        document.getElementById('call_button').style.display = "inline";
        document.getElementById('answer_button').style.display = "none";
        document.getElementById('hangup_button').style.display = "none";
        // } else if (!incomingcall && outgoingcall && !callinprogress) {
        // document.getElementById('call_button').style.display = "inline";
        // document.getElementById('answer_button').style.display = "none";
        // document.getElementById('hangup_button').style.display = "none";
        // console.log("call hung up");
        // socket.emit('callerhungup', function(e) {});
        // outgoingcall = false;
      }
    });

    // socket.on('callerhungup', function(e) {
    //   document.getElementById('answer_button').style.display = "none";
    // });

    socket.on('message', function(data) {
      document.getElementById('messages').innerHTML += "<br>" + data;
    });

    var sendmessage = function() {
      var message = document.getElementById('message').value;
      socket.send(message);
    };

    var tring = function() {
      outgoingcall = true;
      console.log("sending tring tring...");
      socket.emit('tring', function(e) {});
      document.getElementById('call_button').style.display = "none";
      document.getElementById('answer_button').style.display = "none";
      document.getElementById('hangup_button').style.display = "inline";
    }

    var answerCall = function() {
      if (incomingcall && !outgoingcall && !callinprogress) {
        audio.pause();
        incomingcall = false;
        callinprogress = true;
        shareAudio();
        document.getElementById('answer_button').style.display = "none";
      }
    }

    var stopTring = function() {
      console.log("hanging up...");
      socket.emit('hangup', function(e) {});
      document.getElementById('call_button').style.display = "inline";
      document.getElementById('hangup_button').style.display = "none";
      outgoingcall = false;
    }

    function callTushar() {
      console.log("here: " + static_id);
      shareScreen(static_id);
      shareAudio(static_id);
    }

    function shareScreen(idToCall) {
      var call = peer.call(idToCall, my_stream1);

      call.on('stream', function(remoteStream) {
        console.log("Got remote stream");
        var ovideoElement = document.createElement('video');
        ovideoElement.srcObject = remoteStream;
        ovideoElement.setAttribute("autoplay", "true");
        ovideoElement.play();
        document.body.appendChild(ovideoElement);
      });
    }

    function shareAudio(idToCall) {
      var call = peer.call(idToCall, my_stream2);

      call.on('stream', function(remoteStream) {
        console.log("Got remote stream");
        var o0videoElement = document.createElement('video');
        o0videoElement.srcObject = remoteStream;
        o0videoElement.setAttribute("autoplay", "true");
        o0videoElement.play();
        document.body.appendChild(o0videoElement);
      });
    }

    let my_stream1 = null; //screen
    let my_stream2 = null; //audio
    let my_stream3 = null; //video

    let constraints1 = { //screen
      audio: true,
      video: true
    }

    let constraints2 = { //audio
      audio: true,
      video: false
    }

    let constraints3 = { //video
      audio: true,
      video: true
    }

    window.addEventListener('load', function() {
      navigator.mediaDevices.getDisplayMedia(constraints1).then(function(stream1) {
          var videoElement = document.getElementById('myvideo');
          videoElement.srcObject = stream1;
          my_stream1 = stream1;
        })
        .catch(function(err) {
          alert(err);
        });

      navigator.mediaDevices.getUserMedia(constraints2).then(function(stream2) {
          var videoElement = document.getElementById('myaudio');
          videoElement.srcObject = stream2;
          my_stream2 = stream2;
        })
        .catch(function(err) {
          alert(err);
        });

      navigator.mediaDevices.getUserMedia(constraints3).then(function(stream3) {
          var videoElement = document.getElementById('myaudio');
          videoElement.srcObject = stream3;
          my_stream3 = stream3;
        })
        .catch(function(err) {
          alert(err);
        });
    });

    // We'll use a global variable to hold on to our id from PeerJS
    var peer_id = null;
    var static_id = "tushar";
    // I setup a peer server on a Digital Ocean instance for our use, you can use that with the following constructor:
    var peer = new Peer('shawn', {
      host: 'liveweb-new.itp.io',
      port: 9000,
      path: '/'
    });

    // Get an ID from the PeerJS server
    peer.on('open', function(id) {
      console.log('My peer ID is: ' + id);
      peer_id = id;
    });

    peer.on('error', function(err) {
      console.log(err);
    });

    peer.on('call', function(incoming_call) {
      console.log("Got a call!");
      incoming_call.answer(my_stream3); // Answer the call with our stream from getUserMedia
      incoming_call.on('stream', function(remoteStream) { // we receive a getUserMedia stream from the remote caller
        var ovideoElement = document.createElement('video');
        ovideoElement.srcObject = remoteStream;
        ovideoElement.setAttribute("autoplay", "true");
        ovideoElement.play();
        document.body.appendChild(ovideoElement);
      });
    });
  </script>
</head>

<body>
  <div id="messages">
  </div>
  <div>
    <input type="text" id="message" name="message">
    <input type="button" value="message" onclick="sendmessage();">
    <p>
      <input type="button" id="call_button" value="call Tushar" onclick="tring();">
      <input type="button" id="answer_button" value="answer" onclick="answerCall();">
      <input type="button" id="hangup_button" value="hang up" onclick="stopTring();">
  </div>
  <video id="myvideo"></video>
  <video id="myaudio"></video>

  <!-- <audio id="myAudio">
    <source src="horse.ogg" type="audio/ogg">
    <source src="horse.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio> -->

</body>

</html>